<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>HY 475 Robot Simulator</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style>
	* { box-sizing: border-box; margin: 0; padding: 0; }
	body { font-family: Helvetica, 'Open Sans', sans-serif; }
	#render { border: solid 1px black; min-width: 400px; }
	#editor { min-width:400px; width: 100%; height: 80vh; overflow: auto; white-space: pre-wrap; resize: none;
		padding:5px 1em; border: solid 1px black; }
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="math.js"></script>
<script src="js.cookie-2.2.1.min.js"></script>
<script>
	math.import({
		normrnd: function (m = 0, s = 1) {
			var U1 = math.random(0.001, 0.999);
			var U2 = math.random(0.001, 0.999);
			return Math.sqrt(-2*Math.log(U1)) * Math.cos(2*Math.PI*U2) * s + m;
		}
	});
</script>
</head>
<body>
	<table width="100%" border="0">
		<tr>
			<td align="center" style="padding:10px;" width="50%">
				<table width="400">
					<tr>
						<td width="50%">
							<input id="noise" type="checkbox"> noise
						</td>
						<td>
							<input id="trails" type="checkbox" checked> show trail
						</td>
					</tr>
				</table>
				<canvas id="render" width="400" height="400"></canvas>
				<table width="400"><tr><td width="50%"><button id="play" type="button">&#x25B6;</button></td>
				<td><span id="rmse">RMSE: 0.00 px</span></td></tr></table>
			</td>
			<td style="padding:10px;">
				<code><strong><span style="color:#069;">function</span> predict(<em>deltaDir</em>, <em>gpsPos</em>) {</strong></code>
				<textarea id="editor">return [200, 200];</textarea>
				<code><strong>}</strong></code>
			</td>
		</tr>
	</table>

	<script>
		function getContext() { return $('#render')[0].getContext('2d'); }
		function clear() { getContext().clearRect(0, 0, $('#render').width(), $('#render').height()); }

		 function drawBot(x, y, a) {
			var ctx = getContext();
			ctx.beginPath();
			ctx.strokeStyle = '#000';
			ctx.fillStyle = "#fe0";
			ctx.arc(x, y, 15, 0, 2 * Math.PI);
			ctx.fill();
			ctx.moveTo(x, y);
			ctx.lineTo(x+15*Math.cos(a), y-15*Math.sin(a));
			ctx.stroke();
		}

		function drawPath(path, color) {
			var ctx = getContext();
			ctx.beginPath();
			ctx.strokeStyle = color;
			if (path.length > 0) ctx.moveTo(path[0][0], path[0][1]);
			for (var i = 0; i < path.length; i+=5) ctx.lineTo(path[i][0], path[i][1]);
			ctx.stroke();
		}

		function Robot() {
			var x = 200;
			var y = 200;
			var step = 0;
			var hist = [[x, y]];
			var est = [[x, y]];
			var noise = 0;

			this.sim = function(filter) {
				var dirs = $('#path').val().split(',');
				var dir = dirs[step] * 1;
				var deltaDir = dir - (step > 0 ? dirs[step-1] : 0);

				if (noisy) { noise += math.normrnd(0, Math.abs(0.1*deltaDir)); }

				clear();

				if (trails) {
					drawPath(hist, '#3c0');
					drawPath(est, '#c30');
				}

				drawBot(x, y, dir+noise);

				if (!(step % 10)) {
					$('#rmse').html('RMSE: ' + Math.sqrt(math.mean(math.dotPow(math.subtract(hist, est), 2))).toFixed(2) + ' px');
				}
				
				if (on && step < 1000) {
					est.push(filter.pred(deltaDir, [x + math.normrnd(0, 5*noisy), y + math.normrnd(0, 5*noisy)]));
					dir += noise;

					var speed = 2;
					x += speed * Math.cos(dir-deltaDir);
					y -= speed * Math.sin(dir-deltaDir);
					hist.push([x, y]);

					step++;

					setTimeout(function(){ bot.sim(filter); }, 30);
				}
			};
		}

		var on = false;
		var noisy = false;
		var trails = true;
		var bot = {};
		function reset() {
			on = false;
			bot = new Robot();
			bot.sim();
		}

		 $(document).ready(function(){
			 reset();
			 if (typeof Cookies.get('editorState') !== 'undefined'){
			 	$('#editor').val(Cookies.get('editorState'));
			 }

			 $('#noise').change(function(){
				 noisy = !noisy;
			 });

			 $('#trails').change(function(){
				 trails = !trails;
			 });

			 $('#play').click(function(e){
				on = !on;

				if (on) {
					$(this).html('&#x23F9;');
					eval('function filter(){ this.pred = function(deltaDir, gpsPos) {'+ $('#editor').val() +'}; }');
					bot.sim(new filter());
				} else {
					$(this).html('&#x25B6;');
					reset();
				}
			 });

			 $('#editor').on('change keyup paste', function(){
				 Cookies.set('editorState', $(this).val(), {expires: 30});
			 });
		});
	</script>

	<input id="path" type="hidden" value="0.000,-0.146,-0.146,-0.146,-0.146,-0.146,-0.146,-0.146,-0.146,-0.146,-0.181,-0.175,-0.162,-0.155,-0.143,-0.127,-0.228,-0.282,-0.308,-0.346,-0.480,-0.650,-0.687,-0.693,-0.783,-0.865,-0.916,-0.964,-1.010,-1.033,-1.077,-1.118,-1.173,-1.206,-1.221,-1.327,-1.405,-1.453,-1.453,-1.458,-1.549,-1.590,-1.590,-1.636,-1.811,-1.917,-1.944,-2.033,-2.033,-2.055,-2.076,-2.220,-2.367,-2.516,-2.565,-2.544,-2.565,-2.626,-2.695,-2.776,-2.799,-2.839,-2.872,-2.882,-2.889,-2.902,-2.931,-2.942,-2.956,-2.973,-2.981,-2.992,-3.005,-3.039,-3.088,-3.109,-3.130,-3.130,-3.148,-3.166,-3.200,-3.232,-3.263,-3.278,-3.278,-3.312,-3.327,-3.327,-3.343,-3.397,-3.456,-3.475,-3.550,-3.597,-3.641,-3.716,-3.738,-3.801,-3.902,-3.952,-3.986,-4.017,-4.027,-4.068,-4.056,-4.092,-4.110,-4.102,-4.136,-4.131,-4.135,-4.159,-4.157,-4.175,-4.196,-4.204,-4.217,-4.225,-4.238,-4.249,-4.238,-4.250,-4.260,-4.309,-4.321,-4.342,-4.360,-4.371,-4.374,-4.398,-4.446,-4.476,-4.476,-4.499,-4.512,-4.526,-4.551,-4.576,-4.599,-4.635,-4.635,-4.659,-4.693,-4.725,-4.757,-4.757,-4.789,-4.789,-4.798,-4.840,-4.872,-4.912,-4.923,-4.968,-5.006,-5.067,-5.078,-5.110,-5.127,-5.190,-5.230,-5.261,-5.284,-5.322,-5.351,-5.369,-5.397,-5.458,-5.499,-5.522,-5.545,-5.560,-5.589,-5.603,-5.617,-5.624,-5.658,-5.677,-5.689,-5.702,-5.720,-5.731,-5.743,-5.754,-5.776,-5.797,-5.812,-5.822,-5.856,-5.894,-5.902,-5.920,-5.952,-5.977,-5.980,-6.008,-6.022,-6.051,-6.065,-6.093,-6.121,-6.134,-6.134,-6.159,-6.201,-6.228,-6.241,-6.281,-6.294,-6.294,-6.294,-6.321,-6.348,-6.375,-6.401,-6.428,-6.469,-6.512,-6.523,-6.591,-6.642,-6.705,-6.771,-6.822,-6.872,-6.884,-6.920,-6.968,-6.979,-6.991,-6.991,-7.016,-7.041,-7.041,-7.064,-7.064,-7.117,-7.134,-7.138,-7.125,-7.124,-7.130,-7.117,-7.125,-7.123,-7.129,-7.137,-7.150,-7.148,-7.178,-7.181,-7.202,-7.205,-7.225,-7.233,-7.230,-7.243,-7.247,-7.259,-7.256,-7.256,-7.256,-7.263,-7.282,-7.272,-7.269,-7.282,-7.281,-7.284,-7.295,-7.294,-7.291,-7.299,-7.274,-7.291,-7.290,-7.304,-7.320,-7.325,-7.364,-7.383,-7.401,-7.405,-7.419,-7.427,-7.427,-7.432,-7.436,-7.441,-7.449,-7.454,-7.462,-7.479,-7.483,-7.487,-7.495,-7.510,-7.514,-7.525,-7.559,-7.559,-7.568,-7.580,-7.583,-7.589,-7.608,-7.613,-7.613,-7.616,-7.629,-7.629,-7.634,-7.634,-7.637,-7.637,-7.637,-7.637,-7.637,-7.637,-7.637,-7.637,-7.640,-7.640,-7.640,-7.643,-7.665,-7.716,-7.751,-7.788,-7.789,-7.841,-7.875,-7.970,-8.027,-8.056,-8.077,-8.108,-8.135,-8.202,-8.227,-8.242,-8.257,-8.266,-8.266,-8.282,-8.316,-8.349,-8.349,-8.367,-8.385,-8.399,-8.468,-8.485,-8.520,-8.616,-8.687,-8.751,-8.798,-8.830,-8.851,-8.871,-8.900,-8.910,-8.937,-8.963,-9.004,-9.012,-9.069,-9.082,-9.112,-9.160,-9.234,-9.283,-9.304,-9.363,-9.393,-9.409,-9.440,-9.449,-9.469,-9.525,-9.577,-9.616,-9.670,-9.698,-9.714,-9.755,-9.795,-9.807,-9.838,-9.903,-9.972,-10.007,-10.057,-10.089,-10.147,-10.171,-10.186,-10.215,-10.247,-10.258,-10.264,-10.263,-10.281,-10.281,-10.279,-10.283,-10.274,-10.279,-10.279,-10.279,-10.279,-10.279,-10.285,-10.285,-10.277,-10.275,-10.275,-10.244,-10.236,-10.223,-10.210,-10.181,-10.154,-10.156,-10.151,-10.147,-10.148,-10.138,-10.133,-10.125,-10.105,-10.106,-10.080,-10.066,-10.057,-10.040,-10.015,-9.995,-9.995,-9.988,-9.973,-9.965,-9.951,-9.947,-9.940,-9.936,-9.932,-9.929,-9.925,-9.908,-9.904,-9.895,-9.885,-9.879,-9.879,-9.877,-9.874,-9.874,-9.871,-9.871,-9.875,-9.878,-9.881,-9.884,-9.884,-9.887,-9.887,-9.887,-9.887,-9.884,-9.881,-9.887,-9.891,-9.887,-9.887,-9.887,-9.887,-9.897,-9.897,-9.897,-9.897,-9.897,-9.897,-9.897,-9.897,-9.897,-9.897,-9.897,-9.897,-9.897,-9.897,-9.897,-9.897,-10.189,-10.200,-10.250,-10.267,-10.272,-10.300,-10.312,-10.329,-10.356,-10.368,-10.382,-10.399,-10.425,-10.434,-10.451,-10.460,-10.468,-10.477,-10.477,-10.485,-10.506,-10.510,-10.518,-10.533,-10.540,-10.548,-10.548,-10.570,-10.573,-10.580,-10.580,-10.584,-10.587,-10.591,-10.611,-10.614,-10.636,-10.636,-10.643,-10.646,-10.658,-10.685,-10.697,-10.697,-10.715,-10.715,-10.727,-10.742,-10.742,-10.742,-10.745,-10.745,-10.760,-10.774,-10.774,-10.785,-10.823,-10.863,-10.888,-10.888,-10.913,-10.952,-10.976,-11.013,-11.050,-11.062,-11.098,-11.145,-11.145,-11.158,-11.156,-11.180,-11.204,-11.204,-11.201,-11.212,-11.234,-11.248,-11.248,-11.263,-11.278,-11.304,-11.335,-11.360,-11.406,-11.422,-11.514,-11.572,-11.628,-11.706,-11.755,-11.801,-11.833,-11.844,-11.886,-11.937,-11.974,-12.020,-12.055,-12.084,-12.106,-12.134,-12.168,-12.175,-12.212,-12.254,-12.292,-12.327,-12.409,-12.467,-12.525,-12.564,-12.564,-12.584,-12.644,-12.644,-12.688,-12.711,-12.776,-12.800,-12.842,-12.906,-12.954,-13.026,-13.047,-13.100,-13.162,-13.188,-13.254,-13.295,-13.312,-13.314,-13.359,-13.386,-13.425,-13.442,-13.447,-13.444,-13.416,-13.433,-13.419,-13.419,-13.404,-13.402,-13.378,-13.377,-13.343,-13.343,-13.301,-13.281,-13.286,-13.276,-13.266,-13.246,-13.227,-13.190,-13.173,-13.155,-13.122,-13.059,-13.006,-12.956,-12.878,-12.860,-12.773,-12.710,-12.663,-12.646,-12.602,-12.601,-12.587,-12.559,-12.476,-12.441,-12.418,-12.357,-12.324,-12.314,-12.254,-12.221,-12.209,-12.209,-12.174,-12.156,-12.143,-12.130,-12.106,-12.083,-12.073,-12.046,-12.024,-12.008,-12.004,-11.979,-11.947,-11.941,-11.915,-11.905,-11.905,-11.905,-11.893,-11.893,-11.901,-11.888,-11.897,-11.897,-11.894,-11.894,-11.894,-11.904,-11.924,-11.952,-12.052,-12.081,-12.131,-12.137,-12.137,-12.137,-12.171,-12.192,-12.192,-12.219,-12.256,-12.272,-12.294,-12.377,-12.395,-12.395,-12.440,-12.483,-12.584,-12.701,-12.777,-12.826,-12.865,-12.943,-13.019,-13.075,-13.112,-13.218,-13.283,-13.283,-13.361,-13.418,-13.482,-13.550,-13.555,-13.594,-13.613,-13.649,-13.707,-13.744,-13.781,-13.804,-13.821,-13.825,-13.841,-13.866,-13.902,-13.919,-13.938,-13.995,-13.998,-14.049,-14.085,-14.144,-14.144,-14.189,-14.201,-14.212,-14.223,-14.235,-14.235,-14.235,-14.235,-14.235,-14.235,-14.233,-14.233,-14.233,-14.249,-14.293,-14.397,-14.467,-14.520,-14.590,-14.658,-14.698,-14.737,-14.766,-14.769,-14.782,-14.807,-14.822,-14.847,-14.849,-14.838,-14.838,-14.851,-14.868,-14.868,-14.868,-14.868,-14.868,-14.868,-14.868,-14.916,-14.960,-15.064,-15.119,-15.129,-15.144,-15.154,-15.183,-15.219,-15.274,-15.308,-15.333,-15.355,-15.360,-15.366,-15.376,-15.391,-15.401,-15.424,-15.447,-15.462,-15.462,-15.465,-15.482,-15.509,-15.517,-15.517,-15.533,-15.552,-15.556,-15.574,-15.581,-15.626,-15.626,-15.626,-15.626,-15.626,-15.626,-15.629,-15.646,-15.649,-15.649,-15.649,-15.651,-15.652,-15.653,-15.653,-15.655,-15.656,-15.659,-15.662,-15.663,-15.665,-15.665,-15.665,-15.665,-15.666,-15.667,-15.668,-15.671,-15.671,-15.672,-15.672,-15.672,-15.673,-15.674,-15.675,-15.677,-15.699,-15.700,-15.700,-15.700,-15.700,-15.700,-15.700,-15.700,-15.700,-15.700,-15.700,-15.700,-15.701,-15.702,-15.702,-15.702,-15.703,-15.704,-15.704,-15.704,-15.704,-15.704,-15.681,-15.682,-15.659,-15.659,-15.659,-15.659,-15.659,-15.659,-15.659,-15.659,-15.659,-15.621,-15.525,-15.419,-15.345,-15.252,-15.238,-15.226,-15.156,-15.081,-15.050,-15.041,-15.017,-14.977,-14.956,-14.922,-14.888,-14.876,-14.807,-14.781,-14.777,-14.752,-14.718,-14.713,-14.704,-14.666,-14.640,-14.622,-14.614,-14.606,-14.605,-14.598,-14.577,-14.551,-14.539,-14.527,-14.513,-14.492,-14.493,-14.475,-14.462,-14.458,-14.445,-14.433,-14.390,-14.334,-14.312,-14.295,-14.295,-14.280,-14.265,-14.265,-14.248,-14.233,-14.230,-14.201,-14.185,-14.185,-14.169,-14.139,-14.139,-14.109,-14.093,-14.065,-14.051,-14.007,-13.979,-13.911,-13.860,-13.831,-13.816,-13.776,-13.753,-13.723,-13.708,-13.693,-13.632,-13.602,-13.543,-13.514,-13.471,-13.404,-13.342,-13.330,-13.271,-13.185,-13.108,-13.054,-12.991,-12.876,-12.845,-12.800,-12.734,-12.698,-12.640,-12.586,-12.573,-12.535,-12.511,-12.453,-12.433">
</body>
</html>